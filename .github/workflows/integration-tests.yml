name: Integration Tests

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  schedule:
    # Run integration tests daily at 1 AM UTC
    - cron: '0 1 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      kafka:
        image: confluentinc/cp-kafka:7.9.1
        env:
          KAFKA_NODE_ID: 1
          KAFKA_PROCESS_ROLES: "broker,controller"
          KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,CONTROLLER://kafka:29093"
          KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092"
          KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:29093"
          KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
          CLUSTER_ID: "citest123456789012345678901"
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
          KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
          KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
          KAFKA_LOG_DIRS: "/tmp/kraft-combined-logs"
          # Additional transaction settings for CI stability
          KAFKA_TRANSACTION_MAX_TIMEOUT_MS: 60000
          KAFKA_TRANSACTION_ABORT_TIMED_OUT_TRANSACTION_CLEANUP_INTERVAL_MS: 10000
          KAFKA_TRANSACTION_REMOVE_EXPIRED_TRANSACTION_CLEANUP_INTERVAL_MS: 10000
        ports:
          - 9092:9092
          - 29093:29093
        options: >-
          --health-cmd "kafka-topics --bootstrap-server localhost:9092 --list"
          --health-interval 15s
          --health-timeout 10s
          --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Wait for Kafka (KRaft)
      run: |
        echo "Waiting for Kafka KRaft to be ready..."
        timeout 120 bash -c 'until nc -z localhost 9092; do sleep 2; done'
        echo "Kafka port is open, waiting for cluster and transaction coordinator to be ready..."
        sleep 25
        echo "Kafka KRaft with transaction support is ready!"
    
    - name: Create test topics
      run: |
        # Install Kafka tools
        wget -qO- https://archive.apache.org/dist/kafka/2.8.0/kafka_2.13-2.8.0.tgz | tar xz
        export PATH="$PWD/kafka_2.13-2.8.0/bin:$PATH"
        
        # Create test topics
        kafka-topics.sh --create --bootstrap-server localhost:9092 --topic test-topic --partitions 3 --replication-factor 1 || true
        kafka-topics.sh --create --bootstrap-server localhost:9092 --topic integration-test --partitions 1 --replication-factor 1 || true
        
        # List topics to verify
        kafka-topics.sh --list --bootstrap-server localhost:9092
    
    - name: Run integration tests
      run: |
        # Run tests that require Kafka with delays to prevent resource contention
        echo "Running kafka_integration_test..."
        cargo test integration::kafka_integration_test -- --nocapture
        echo "Waiting 30 seconds before next test suite..."
        sleep 30
        
        echo "Running kafka_advanced_test..."
        cargo test integration::kafka_advanced_test -- --nocapture
        echo "Waiting 30 seconds before next test suite..."
        sleep 30
        
        
        echo "Running remaining integration tests (excluding failure_recovery and transaction)..."
        cargo test integration -- --nocapture --skip failure_recovery_test --skip transaction_test
      env:
        KAFKA_BROKERS: localhost:9092
        RUST_LOG: debug
    
    - name: Build binaries for multi-job tests
      run: |
        echo "Building ferris-sql-multi binary for integration tests..."
        cargo build --release --bin ferris-sql-multi
        
        # Verify binary was built
        ls -la target/release/ferris-sql-multi

    - name: Run multi-job SQL server tests
      run: |
        echo "Running multi-job SQL server integration tests..."
        cargo test --test test_multi_job_sql_server -- --nocapture
      env:
        KAFKA_BROKERS: localhost:9092
        RUST_LOG: info

    - name: Build and test examples
      run: |
        echo "Waiting 20 seconds before building examples..."
        sleep 20
        echo "Testing examples that don't require long-running processes..."
        
        # Build all examples to ensure they compile
        cargo build --example builder_configuration
        cargo build --example consumer_with_headers  
        cargo build --example fluent_api_example
        cargo build --example headers_example
        cargo build --example message_metadata_example
        cargo build --example typed_kafka_example
        
        echo "All examples built successfully!"
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          target/debug/deps/*/test-results.xml
          target/debug/deps/*/coverage.xml
        retention-days: 7